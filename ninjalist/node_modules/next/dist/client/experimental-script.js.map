{"version":3,"sources":["../../client/experimental-script.tsx"],"names":["ScriptCache","Map","LoadCache","Set","loadScript","props","src","onLoad","dangerouslySetInnerHTML","children","id","onError","cacheKey","has","add","get","then","el","document","createElement","loadPromise","Promise","resolve","reject","addEventListener","call","set","innerHTML","__html","textContent","Array","isArray","join","k","value","Object","entries","undefined","attr","DOMAttributeNames","toLowerCase","setAttribute","body","appendChild","Script","strategy","preload","restProps","updateScripts","scripts","HeadManagerContext","window","syncProps","defer","concat","eager"],"mappings":"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","sourcesContent":["import React, { useEffect, useContext } from 'react'\nimport { ScriptHTMLAttributes } from 'react'\nimport { HeadManagerContext } from '../next-server/lib/head-manager-context'\nimport { DOMAttributeNames } from './head-manager'\nimport { requestIdleCallback } from './request-idle-callback'\n\nconst ScriptCache = new Map()\nconst LoadCache = new Set()\n\ninterface Props extends ScriptHTMLAttributes<HTMLScriptElement> {\n  strategy?: 'defer' | 'lazy' | 'dangerouslyBlockRendering' | 'eager'\n  id?: string\n  onLoad?: () => void\n  onError?: () => void\n  children?: React.ReactNode\n  preload?: boolean\n}\n\nconst loadScript = (props: Props): void => {\n  const {\n    src = '',\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    children = '',\n    id,\n    onError,\n  } = props\n\n  const cacheKey = id || src\n  if (ScriptCache.has(src)) {\n    if (!LoadCache.has(cacheKey)) {\n      LoadCache.add(cacheKey)\n      // Execute onLoad since the script loading has begun\n      ScriptCache.get(src).then(onLoad, onError)\n    }\n    return\n  }\n\n  const el = document.createElement('script')\n\n  const loadPromise = new Promise((resolve, reject) => {\n    el.addEventListener('load', function () {\n      resolve()\n      if (onLoad) {\n        onLoad.call(this)\n      }\n    })\n    el.addEventListener('error', function () {\n      reject()\n      if (onError) {\n        onError()\n      }\n    })\n  })\n\n  if (src) {\n    ScriptCache.set(src, loadPromise)\n    LoadCache.add(cacheKey)\n  }\n\n  if (dangerouslySetInnerHTML) {\n    el.innerHTML = dangerouslySetInnerHTML.__html || ''\n  } else if (children) {\n    el.textContent =\n      typeof children === 'string'\n        ? children\n        : Array.isArray(children)\n        ? children.join('')\n        : ''\n  } else if (src) {\n    el.src = src\n  }\n\n  for (const [k, value] of Object.entries(props)) {\n    if (value === undefined) {\n      continue\n    }\n\n    const attr = DOMAttributeNames[k] || k.toLowerCase()\n    el.setAttribute(attr, value)\n  }\n\n  document.body.appendChild(el)\n}\n\nexport default function Script(props: Props): JSX.Element | null {\n  const {\n    src = '',\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    children = '',\n    strategy = 'defer',\n    onError,\n    preload = false,\n    ...restProps\n  } = props\n\n  // Context is available only during SSR\n  const { updateScripts, scripts } = useContext(HeadManagerContext)\n\n  useEffect(() => {\n    if (strategy === 'defer') {\n      loadScript(props)\n    } else if (strategy === 'lazy') {\n      window.addEventListener('load', () => {\n        requestIdleCallback(() => loadScript(props))\n      })\n    }\n  }, [strategy, props])\n\n  if (strategy === 'dangerouslyBlockRendering') {\n    const syncProps: Props = { ...restProps }\n\n    for (const [k, value] of Object.entries({\n      src,\n      onLoad,\n      onError,\n      dangerouslySetInnerHTML,\n      children,\n    })) {\n      if (!value) {\n        continue\n      }\n      if (k === 'children') {\n        syncProps.dangerouslySetInnerHTML = {\n          __html:\n            typeof value === 'string'\n              ? value\n              : Array.isArray(value)\n              ? value.join('')\n              : '',\n        }\n      } else {\n        ;(syncProps as any)[k] = value\n      }\n    }\n\n    return <script {...syncProps} />\n  } else if (strategy === 'defer') {\n    if (updateScripts && preload) {\n      scripts.defer = (scripts.defer || []).concat([src])\n      updateScripts(scripts)\n    }\n  } else if (strategy === 'eager') {\n    if (updateScripts) {\n      scripts.eager = (scripts.eager || []).concat([\n        {\n          src,\n          onLoad,\n          onError,\n          ...restProps,\n        },\n      ])\n      updateScripts(scripts)\n    }\n  }\n\n  return null\n}\n"]}