{"version":3,"sources":["../../../build/output/index.ts"],"names":["startedDevelopmentServer","appUrl","bindAddr","consoleStore","setState","previousClient","previousServer","WebpackStatusPhase","getWebpackStatusPhase","status","loading","COMPILING","errors","COMPILED_WITH_ERRORS","warnings","COMPILED_WITH_WARNINGS","COMPILED","formatAmpMessages","amp","output","chalk","bold","messages","chalkError","red","ampError","page","error","push","message","specUrl","chalkWarn","yellow","ampWarn","warn","devOnlyFilter","err","code","filter","length","index","align","stringLength","str","buildStore","subscribe","state","client","server","phase","sort","a","b","valueOf","bootstrap","bootstrapping","getState","partialState","Object","keys","concat","typeChecking","ampValidation","k","reduce","c","newAmp","watchCompilers","tapCompiler","key","compiler","onEvent","hooks","invalid","tap","done","stats","toJson","all","hasErrors","hasWarnings"],"mappings":"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","sourcesContent":["import chalk from 'chalk'\nimport stripAnsi from 'next/dist/compiled/strip-ansi'\nimport textTable from 'next/dist/compiled/text-table'\nimport createStore from 'next/dist/compiled/unistore'\nimport formatWebpackMessages from '../../client/dev/error-overlay/format-webpack-messages'\nimport { OutputState, store as consoleStore } from './store'\n\nexport function startedDevelopmentServer(appUrl: string, bindAddr: string) {\n  consoleStore.setState({ appUrl, bindAddr })\n}\n\nlet previousClient: import('webpack').Compiler | null = null\nlet previousServer: import('webpack').Compiler | null = null\n\ntype CompilerDiagnosticsWithFile = {\n  errors: { file: string | undefined; message: string }[] | null\n  warnings: { file: string | undefined; message: string }[] | null\n}\n\ntype CompilerDiagnostics = {\n  errors: string[] | null\n  warnings: string[] | null\n}\n\ntype WebpackStatus =\n  | { loading: true }\n  | ({ loading: false } & CompilerDiagnostics)\n\ntype AmpStatus = {\n  message: string\n  line: number\n  col: number\n  specUrl: string | null\n  code: string\n}\n\nexport type AmpPageStatus = {\n  [page: string]: { errors: AmpStatus[]; warnings: AmpStatus[] }\n}\n\ntype BuildStatusStore = {\n  client: WebpackStatus\n  server: WebpackStatus\n  amp: AmpPageStatus\n}\n\nenum WebpackStatusPhase {\n  COMPILING = 1,\n  COMPILED_WITH_ERRORS = 2,\n  COMPILED_WITH_WARNINGS = 4,\n  COMPILED = 5,\n}\n\nfunction getWebpackStatusPhase(status: WebpackStatus): WebpackStatusPhase {\n  if (status.loading) {\n    return WebpackStatusPhase.COMPILING\n  }\n  if (status.errors) {\n    return WebpackStatusPhase.COMPILED_WITH_ERRORS\n  }\n  if (status.warnings) {\n    return WebpackStatusPhase.COMPILED_WITH_WARNINGS\n  }\n  return WebpackStatusPhase.COMPILED\n}\n\nexport function formatAmpMessages(amp: AmpPageStatus) {\n  let output = chalk.bold('Amp Validation') + '\\n\\n'\n  let messages: string[][] = []\n\n  const chalkError = chalk.red('error')\n  function ampError(page: string, error: AmpStatus) {\n    messages.push([page, chalkError, error.message, error.specUrl || ''])\n  }\n\n  const chalkWarn = chalk.yellow('warn')\n  function ampWarn(page: string, warn: AmpStatus) {\n    messages.push([page, chalkWarn, warn.message, warn.specUrl || ''])\n  }\n\n  for (const page in amp) {\n    let { errors, warnings } = amp[page]\n\n    const devOnlyFilter = (err: AmpStatus) => err.code !== 'DEV_MODE_ONLY'\n    errors = errors.filter(devOnlyFilter)\n    warnings = warnings.filter(devOnlyFilter)\n    if (!(errors.length || warnings.length)) {\n      // Skip page with no non-dev warnings\n      continue\n    }\n\n    if (errors.length) {\n      ampError(page, errors[0])\n      for (let index = 1; index < errors.length; ++index) {\n        ampError('', errors[index])\n      }\n    }\n    if (warnings.length) {\n      ampWarn(errors.length ? '' : page, warnings[0])\n      for (let index = 1; index < warnings.length; ++index) {\n        ampWarn('', warnings[index])\n      }\n    }\n    messages.push(['', '', '', ''])\n  }\n\n  if (!messages.length) {\n    return ''\n  }\n\n  output += textTable(messages, {\n    align: ['l', 'l', 'l', 'l'],\n    stringLength(str: string) {\n      return stripAnsi(str).length\n    },\n  })\n\n  return output\n}\n\nconst buildStore = createStore<BuildStatusStore>()\n\nbuildStore.subscribe((state) => {\n  const { amp, client, server } = state\n\n  const [{ status }] = [\n    { status: client, phase: getWebpackStatusPhase(client) },\n    { status: server, phase: getWebpackStatusPhase(server) },\n  ].sort((a, b) => a.phase.valueOf() - b.phase.valueOf())\n\n  const { bootstrap: bootstrapping, appUrl } = consoleStore.getState()\n  if (bootstrapping && status.loading) {\n    return\n  }\n\n  let partialState: Partial<OutputState> = {\n    bootstrap: false,\n    appUrl: appUrl!,\n  }\n\n  if (status.loading) {\n    consoleStore.setState(\n      { ...partialState, loading: true } as OutputState,\n      true\n    )\n  } else {\n    let { errors, warnings } = status\n\n    if (errors == null) {\n      if (Object.keys(amp).length > 0) {\n        warnings = (warnings || []).concat(formatAmpMessages(amp) || [])\n        if (!warnings.length) warnings = null\n      }\n    }\n\n    consoleStore.setState(\n      {\n        ...partialState,\n        loading: false,\n        typeChecking: false,\n        errors,\n        warnings,\n      } as OutputState,\n      true\n    )\n  }\n})\n\nexport function ampValidation(\n  page: string,\n  errors: AmpStatus[],\n  warnings: AmpStatus[]\n) {\n  const { amp } = buildStore.getState()\n  if (!(errors.length || warnings.length)) {\n    buildStore.setState({\n      amp: Object.keys(amp)\n        .filter((k) => k !== page)\n        .sort()\n        // eslint-disable-next-line no-sequences\n        .reduce((a, c) => ((a[c] = amp[c]), a), {} as AmpPageStatus),\n    })\n    return\n  }\n\n  const newAmp: AmpPageStatus = { ...amp, [page]: { errors, warnings } }\n  buildStore.setState({\n    amp: Object.keys(newAmp)\n      .sort()\n      // eslint-disable-next-line no-sequences\n      .reduce((a, c) => ((a[c] = newAmp[c]), a), {} as AmpPageStatus),\n  })\n}\n\nexport function watchCompilers(\n  client: import('webpack').Compiler,\n  server: import('webpack').Compiler\n) {\n  if (previousClient === client && previousServer === server) {\n    return\n  }\n\n  buildStore.setState({\n    client: { loading: true },\n    server: { loading: true },\n  })\n\n  function tapCompiler(\n    key: string,\n    compiler: any,\n    onEvent: (status: WebpackStatus) => void\n  ) {\n    compiler.hooks.invalid.tap(`NextJsInvalid-${key}`, () => {\n      onEvent({ loading: true })\n    })\n\n    compiler.hooks.done.tap(\n      `NextJsDone-${key}`,\n      (stats: import('webpack').Stats) => {\n        buildStore.setState({ amp: {} })\n\n        const { errors, warnings } = formatWebpackMessages(\n          stats.toJson({ all: false, warnings: true, errors: true })\n        )\n\n        const hasErrors = !!errors?.length\n        const hasWarnings = !!warnings?.length\n\n        onEvent({\n          loading: false,\n          errors: hasErrors ? errors : null,\n          warnings: hasWarnings ? warnings : null,\n        })\n      }\n    )\n  }\n\n  tapCompiler('client', client, (status) =>\n    buildStore.setState({ client: status })\n  )\n  tapCompiler('server', server, (status) =>\n    buildStore.setState({ server: status })\n  )\n\n  previousClient = client\n  previousServer = server\n}\n"]}