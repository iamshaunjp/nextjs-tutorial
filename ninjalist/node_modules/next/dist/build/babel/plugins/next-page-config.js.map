{"version":3,"sources":["../../../../build/babel/plugins/next-page-config.ts"],"names":["CONFIG_KEY","replaceBundle","path","t","parentPath","replaceWith","program","variableDeclaration","variableDeclarator","identifier","STRING_LITERAL_DROP_BUNDLE","stringLiteral","Date","now","errorMessage","state","details","pageName","filename","split","cwd","pop","nextPageConfig","types","visitor","Program","enter","traverse","ExportDeclaration","exportPath","exportState","BabelTypes","isExportNamedDeclaration","node","specifiers","some","specifier","isIdentifier","exported","name","value","isStringLiteral","source","Error","ExportNamedDeclaration","bundleDropped","declaration","length","config","declarations","scope","getBinding","filter","Boolean","local","isImportSpecifier","id","isObjectExpression","init","got","type","prop","properties","isSpreadElement","key","isObjectProperty","isBooleanLiteral","amp","file","opts","caller","isDev"],"mappings":"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","sourcesContent":["import {\n  NodePath,\n  PluginObj,\n  PluginPass,\n  types as BabelTypes,\n  Visitor,\n} from 'next/dist/compiled/babel/core'\nimport { PageConfig } from 'next/types'\nimport { STRING_LITERAL_DROP_BUNDLE } from '../../../next-server/lib/constants'\n\nconst CONFIG_KEY = 'config'\n\n// replace program path with just a variable with the drop identifier\nfunction replaceBundle(path: any, t: typeof BabelTypes): void {\n  path.parentPath.replaceWith(\n    t.program(\n      [\n        t.variableDeclaration('const', [\n          t.variableDeclarator(\n            t.identifier(STRING_LITERAL_DROP_BUNDLE),\n            t.stringLiteral(`${STRING_LITERAL_DROP_BUNDLE} ${Date.now()}`)\n          ),\n        ]),\n      ],\n      []\n    )\n  )\n}\n\nfunction errorMessage(state: any, details: string): string {\n  const pageName =\n    (state.filename || '').split(state.cwd || '').pop() || 'unknown'\n  return `Invalid page config export found. ${details} in file ${pageName}. See: https://err.sh/vercel/next.js/invalid-page-config`\n}\n\ninterface ConfigState extends PluginPass {\n  bundleDropped?: boolean\n}\n\n// config to parsing pageConfig for client bundles\nexport default function nextPageConfig({\n  types: t,\n}: {\n  types: typeof BabelTypes\n}): PluginObj {\n  return {\n    visitor: {\n      Program: {\n        enter(path, state) {\n          path.traverse(\n            {\n              ExportDeclaration(exportPath, exportState) {\n                if (\n                  BabelTypes.isExportNamedDeclaration(exportPath) &&\n                  (exportPath.node as BabelTypes.ExportNamedDeclaration).specifiers?.some(\n                    (specifier) => {\n                      return (\n                        (t.isIdentifier(specifier.exported)\n                          ? specifier.exported.name\n                          : specifier.exported.value) === CONFIG_KEY\n                      )\n                    }\n                  ) &&\n                  BabelTypes.isStringLiteral(\n                    (exportPath.node as BabelTypes.ExportNamedDeclaration)\n                      .source\n                  )\n                ) {\n                  throw new Error(\n                    errorMessage(\n                      exportState,\n                      'Expected object but got export from'\n                    )\n                  )\n                }\n              },\n              ExportNamedDeclaration(\n                exportPath: NodePath<BabelTypes.ExportNamedDeclaration>,\n                exportState: any\n              ) {\n                if (\n                  exportState.bundleDropped ||\n                  (!exportPath.node.declaration &&\n                    exportPath.node.specifiers.length === 0)\n                ) {\n                  return\n                }\n\n                const config: PageConfig = {}\n                const declarations: BabelTypes.VariableDeclarator[] = [\n                  ...((exportPath.node\n                    .declaration as BabelTypes.VariableDeclaration)\n                    ?.declarations || []),\n                  exportPath.scope.getBinding(CONFIG_KEY)?.path\n                    .node as BabelTypes.VariableDeclarator,\n                ].filter(Boolean)\n\n                for (const specifier of exportPath.node.specifiers) {\n                  if (\n                    (t.isIdentifier(specifier.exported)\n                      ? specifier.exported.name\n                      : specifier.exported.value) === CONFIG_KEY\n                  ) {\n                    // export {} from 'somewhere'\n                    if (BabelTypes.isStringLiteral(exportPath.node.source)) {\n                      throw new Error(\n                        errorMessage(\n                          exportState,\n                          `Expected object but got import`\n                        )\n                      )\n                      // import hello from 'world'\n                      // export { hello as config }\n                    } else if (\n                      BabelTypes.isIdentifier(\n                        (specifier as BabelTypes.ExportSpecifier).local\n                      )\n                    ) {\n                      if (\n                        BabelTypes.isImportSpecifier(\n                          exportPath.scope.getBinding(\n                            (specifier as BabelTypes.ExportSpecifier).local.name\n                          )?.path.node\n                        )\n                      ) {\n                        throw new Error(\n                          errorMessage(\n                            exportState,\n                            `Expected object but got import`\n                          )\n                        )\n                      }\n                    }\n                  }\n                }\n\n                for (const declaration of declarations) {\n                  if (\n                    !BabelTypes.isIdentifier(declaration.id, {\n                      name: CONFIG_KEY,\n                    })\n                  ) {\n                    continue\n                  }\n\n                  if (!BabelTypes.isObjectExpression(declaration.init)) {\n                    const got = declaration.init\n                      ? declaration.init.type\n                      : 'undefined'\n                    throw new Error(\n                      errorMessage(\n                        exportState,\n                        `Expected object but got ${got}`\n                      )\n                    )\n                  }\n\n                  for (const prop of declaration.init.properties) {\n                    if (BabelTypes.isSpreadElement(prop)) {\n                      throw new Error(\n                        errorMessage(\n                          exportState,\n                          `Property spread is not allowed`\n                        )\n                      )\n                    }\n                    const { name } = prop.key as BabelTypes.Identifier\n                    if (BabelTypes.isIdentifier(prop.key, { name: 'amp' })) {\n                      if (!BabelTypes.isObjectProperty(prop)) {\n                        throw new Error(\n                          errorMessage(\n                            exportState,\n                            `Invalid property \"${name}\"`\n                          )\n                        )\n                      }\n                      if (\n                        !BabelTypes.isBooleanLiteral(prop.value) &&\n                        !BabelTypes.isStringLiteral(prop.value)\n                      ) {\n                        throw new Error(\n                          errorMessage(\n                            exportState,\n                            `Invalid value for \"${name}\"`\n                          )\n                        )\n                      }\n                      config.amp = prop.value.value as PageConfig['amp']\n                    }\n                  }\n                }\n\n                if (config.amp === true) {\n                  if (!exportState.file?.opts?.caller.isDev) {\n                    // don't replace bundle in development so HMR can track\n                    // dependencies and trigger reload when they are changed\n                    replaceBundle(exportPath, t)\n                  }\n                  exportState.bundleDropped = true\n                  return\n                }\n              },\n            },\n            state\n          )\n        },\n      },\n    } as Visitor<ConfigState>,\n  }\n}\n"]}